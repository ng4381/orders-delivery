<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>KTM-Stages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>

<body>
    <nav th:replace="~{layouts/main_layout :: nav}"></nav>

    <div class="container">

        <div class="row">

            <div>
                <button id="getData" class="btn btn-primary">Update</button>
                <button id="createNewRoute" class="btn btn-primary">Create new route</button>

            </div>

        </div>

        <div class="row">
            <div class="col-8">

                <h2>Order details</h2>

                

                <table id="deliveryOrders" class="table">
                    

                </table>
            </div>

            <div class="col">
                <h2>Routes</h2>
            </div>

        </div>
    </div>
    <script>

        var urlRoutes = "http://localhost:8077/routes";
        var urlDeliveryOrderDetails = "http://localhost:8077/delivery-orders-details";


        function isEmail() {
            console.log("asdfasfdas");
        }

        function updateRouteList() {
            var jqxhr = $.getJSON(urlRoutes, function (data) {
                console.log("success  url = " + urlRoutes);

                //$('#routes').find('a').remove();

                $('#routes').append("<li><a class='dropdown-item' href='#' id='new_route' onclick='isEmail()' >New Route ...</a></li>");

                $.each(data, function (i, v) {

                    var id_a = 'id_a_' + i;

                    var htmlTr = '<li><a id=' + id_a + ' class="dropdown-item" href="#""> Route â„– ' + v.id + '</a></li>';

                    $('#routes').append(htmlTr);
                    $('#' + id_a).val(v);

                })

            })
                .done(function () {
                    console.log("second success");
                })
                .fail(function () {
                    console.log("error");
                })
                .always(function () {
                    console.log("complete");
                });

            jqxhr.always(function () {
                console.log("second complete");
            });

        }



        function updateTable() {

            var jqxhr = $.getJSON(urlDeliveryOrderDetails, function (data) {
                console.log("success  url = " + urlDeliveryOrderDetails);

                $('#deliveryOrders').find('tr').remove();

                $('#deliveryOrders').append(
                    '<thead class="table-dark"><tr>' +
                    '<th>deliveryOrderId</th>' +
                    '<th>deliveryOrderExtOrderId</th>' +
                    '<th>productName</th>' +
                    '<th>qty (total)</th>' +
                    '<th>qty (remain)</th>' +
                    '<th>qty</th>' +
                    '</tr></thead>');

                $.each(data, function (i, v) {

                    var idTr = 'idTr_' + i;
                    var idInput = 'idInput_' + i;

                    var htmlTr = '<tr id= ' + idTr + '><td>' + v.deliveryOrderId + '</td>'
                        + '<td>' + v.deliveryOrderExtOrderId + '</td>'
                        + '<td>' + v.productName + '</td>'
                        + '<td>' + v.qty + '</td>'
                        + '<td> - </td>'
                        + '<td> <input id=' + idInput + ' type="number" class="form-control"/> </td>'
                        + '</tr>';

                    $('#deliveryOrders').append(htmlTr);
                    $('#' + idTr).val(v);
                    $('#' + idInput).val(v);

                })

            })
                .done(function () {
                    console.log("second success");


                })
                .fail(function () {
                    console.log("error");
                })
                .always(function () {
                    console.log("complete");
                });

            jqxhr.always(function () {
                console.log("second complete");
            });



            console.log(JSON.stringify());
        }


        function createNewRoute() {
            updateRouteList();
        }

        $(document).ready(function () {

            $('#getData').click(function () {
                updateTable();
                updateRouteList();
            })

            $('#createNewRoute').click(function () {
                console.log("creating new route...");
                createNewRoute();
            })


            /*
 
            $('#test').click(function(){
                $('#deliveryOrders').find('tr').remove();
            })
 
 
            $('#postData').click(function(){
 
                $('#deliveryOrders').find("tr").each(function(){
                    $(this).val().qtyDone = parseInt($(this).find('input').val());
                })
 
                var arr = [];
 
                $('#deliveryOrders').find("tr").each(function(){
                    var rowVal = $(this).val();
                    if(rowVal != '' && rowVal.qtyDone > 0) {
                        arr.push($(this).val());
                    }
                })
 
                var arrJson = JSON.stringify (arr);
 
                console.log(arr);
                console.log(arrJson);
 
                $.ajax({
                    url:url,
                    type:"POST",
                    data:arrJson,
                    contentType:"application/json; charset=utf-8",
                    dataType:"json",
                    success: function(){
 
                    }
                })
 
            });
            */



        });
    </script>
</body>